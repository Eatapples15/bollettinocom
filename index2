<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mappa Dinamica</title>
    <style>
        .controls-container {
            margin-top: 20px;
            display: flex;
            gap: 20px;
            align-items: center;
        }

        #controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px 20px;
            align-items: center;
        }

        #controls > div {
            display: flex;
            align-items: center;
        }

        #controls label {
            margin-right: 5px;
        }

        .no-print {
            /* Stili per nascondere gli elementi durante la stampa */
        }
    </style>
</head>
<body>

    <div id="map-container">
        <svg xmlns="http://www.w3.org/2000/svg" version="1.2" baseProfile="tiny" width="1000" height="1026"
            viewBox="0 0 1000 1026" stroke-linecap="round" stroke-linejoin="round">
            <g id="A1"><path id="Montemilone" d="M 100 100 L 200 100 L 200 150 L 100 150 Z" fill="#ccc" stroke="black" stroke-width="1"/></g>
            <g id="A2"><path id="MuroLucano" d="M 250 100 L 350 100 L 350 150 L 250 150 Z" fill="#ccc" stroke="black" stroke-width="1"/></g>
            <g id="B"><path id="Abriola" d="M 400 100 L 500 100 L 500 150 L 400 150 Z" fill="#ccc" stroke="black" stroke-width="1"/></g>
            <g id="C"><path id="Montemurro" d="M 550 100 L 650 100 L 650 150 L 550 150 Z" fill="#ccc" stroke="black" stroke-width="1"/></g>
            <g id="D"><path id="Nemoli" d="M 700 100 L 800 100 L 800 150 L 700 150 Z" fill="#ccc" stroke="black" stroke-width="1"/></g>
            <g id="E1"><path id="NovaSiri" d="M 100 200 L 200 200 L 200 250 L 100 250 Z" fill="#ccc" stroke="black" stroke-width="1"/></g>
            <g id="E2"><path id="Montescaglioso" d="M 250 200 L 350 200 L 350 250 L 250 250 Z" fill="#ccc" stroke="black" stroke-width="1"/></g>
            <path id="paese_singolo" d="M 400 200 L 500 200 L 500 250 L 400 250 Z" fill="#ddd" stroke="black" stroke-width="1"/>
        </svg>
    </div>

    <div class="controls-container">
        <div id="controls" class="no-print">
            <h3>Seleziona Colore Base</h3>
        </div>
        <button class="no-print" onclick="window.print();">Salva PDF</button>
        <button id="generaMappa" class="no-print">Genera Mappa</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvg@4.0.1/lib/umd.js"></script>
    <script>
        const A1 = [
            "Montemilone",
            "Atella",
            "PalazzoSanGervasio",
            "Pescopagano",
            "Rapolla",
            "Rapone",
            "RioneroinVulture",
            "Ripacandida",
            "RuvodelMonte",
            "SanFele",
            "Filiano",
            "Forenza",
            "Lavello",
            "Barile",
            "Maschito",
            "Melfi",
            "Venosa",
            "Ginestra",
        ];

        const A2 = [
            "MuroLucano",
            "Balvano",
            "Baragiano",
            "Bella",
            "Brienza",
            "Castelgrande",
            "Picerno",
            "Ruoti",
            "SantAngeloLeFratte",
            "SassodiCastalda",
            "SatrianodiLucania",
            "SavoiadiLucania",
            "Tito",
            "VietridiPotenza",
        ];

        const B = [
            "Abriola",
            "Accettura",
            "Acerenza",
            "AlbanodiLucania",
            "Anzi",
            "Avigliano",
            "Banzi",
           "BrindisiMontagna",
          "Calciano",
            "Calvello",
            "Campomaggiore",
            "Cancellara",
            "Castelmezzano",
            "Ferrandina",
            "Filiano",
            "Forenza",
            "Garaguso",
            "GenzanodiLucania",
            "Grassano",
            "Grottole",
            "Irsina",
            "Laurenzana",
            "Miglionico",
            "OlivetoLucano",
            "OppidoLucano",
            "Pietragalla",
          "Pietrapertosa",
            "Pignola",
            "Pomarico",
            "Potenza",
            "Salandra",
            "SanChiricoNuovo",
            "SanMauroForte",
            "Tito",
            "Tolve",
            "Tricarico",
            "Trivigno",
            "VaglioBasilicata",
            "Matera",
        ];

        const C = [
            "Montemurro",
            "Aliano",
            "Armento",
            "Calvera",
            "Carbone",
            "CastronuovodiSantAndrea",
            "Cersosimo",
            "Chiaromonte",
            "Cirigliano",
            "Colobraro",
            "CorletoPerticara",
            "Episcopia",
            "Fardella",
            "FrancavillainSinni",
            "Gallicchio",
            "Gorgoglione",
            "GrumentoNova",
            "GuardiaPerticara",
            "MarsicoNuovo",
            "Marsicovetere",
            "Missanello",
            "Moliterno",
            "Noepoli",
            "Paterno",
            "Roccanova",
            "SanChiricoRaparo",
            "SanCostantinoAlbanese",
            "SanGiorgioLucano",
            "SanMartinodAgri",
            "SanPaoloAlbanese",
            "SanSeverinoLucano",
            "SantArcangelo",
            "Sarconi",
            "Senise",
            "Spinoso",
            "Stigliano",
            "Teana",
            "TerranovadiPollino",
            "Tramutola",
            "Tursi",
            "Valsinni",
            "Viggiano",
        ];

        const D = [
            "Nemoli",
            "CastelluccioInferiore",
            "CastelluccioSuperiore",
            "Castelsaraceno",
            "Lagonegro",
            "Latronico",
            "Lauria",
            "Maratea",
            "Rivello",
            "Rotonda",
            "Trecchina",
            "Viggianello",
        ];

        const E1 = [
            "NovaSiri",
            "Policoro",
            "Rotondella",
            "ScanzanoJonico",
            "Tursi",
            "MontalbanoJonico",
            "Craco",
        ];

        const E2 = [
            "Montescaglioso",
            "Bernalda",
            "Pisticci",
            "Pomarico",
            "Ferrandina",
        ];

        const colori = {
            "": "Default",
            "red": "Rosso",
            "yellow": "Giallo",
            "orange": "Arancione",
            "green": "Verde"
        };

        document.addEventListener('DOMContentLoaded', function () {
            const nomiPaesi = [];

            document.querySelectorAll('svg g, svg path').forEach(element => {
                const id = element.id;
                if (id && !id.startsWith('p_')) {
                    nomiPaesi.push(id);
                }
            });


            const controlsContainer = document.getElementById('controls');

            const basi = { A1, A2, B, C, D, E1, E2 };


            Object.keys(basi).forEach(baseName => {
                const svgElement = document.getElementById(baseName);

                const controlDiv = document.createElement('div');

                const label = document.createElement('label');
                label.setAttribute('for', `select-${baseName}`);
                label.textContent = baseName + ':';
                controlDiv.appendChild(label);

                const select = document.createElement('select');
                select.id = `select-${baseName}`;

                select.dataset.targetId = baseName;

                for (const value in colori) {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = colori[value];
                    select.appendChild(option);
                }

                select.addEventListener('change', function (event) {
                    console.log(`Cambio colore per ${baseName}: ${event.target.value}`);

                    const selectedColor = event.target.value;
                    const targetId = event.target.dataset.targetId;

                    printCities(basi[baseName], selectedColor);
                });

                controlDiv.appendChild(select);
                controlsContainer.appendChild(controlDiv);
            });

            // Codice per la generazione della mappa come JPG
            const generaMappaButton = document.getElementById('generaMappa');
            const mapContainer = document.getElementById('map-container');
            const svgElement = mapContainer.querySelector('svg');

            generaMappaButton.addEventListener('click', function() {
                if (svgElement) {
                    const svgString = new XMLSerializer().serializeToString(svgElement);
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    const bbox = svgElement.getBBox();
                    canvas.width = bbox.width;
                    canvas.height = bbox.height;

                    canvg(canvas, svgString, {
                        renderCallback: function() {
                            const imageDataURL = canvas.toDataURL('image/jpeg');
                            window.open(imageDataURL);
                        }
                    });
                } else {
                    alert('Elemento SVG non trovato.');
                }
            });
        });

        function printCities(paesi, selectedColor) {
            for (const paese of paesi) {
                const targetId = paese;
                const elementToColor = document.getElementById(targetId);

                if (elementToColor) {
                    if (elementToColor.childElementCount > 0) {
                        const children = elementToColor.children;
                        for (const child of children) {
                            if (selectedColor) {
                                child.style.fill = selectedColor;
                            } else {
                                child.style.fill = '';
                            }
                        }
                    }
                    if (selectedColor) {
                        elementToColor.style.fill = selectedColor;
                    } else {
                        elementToColor.style.fill = '';
                    }

                } else {
                    console.error(`Elemento SVG con id "${targetId}" non trovato durante il cambio colore.`);
                }
            }
        }
    </script>

</body>
</html>
